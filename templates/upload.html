{% extends "base.html" %}

{% block title %}Upload Data - Data Analysis Platform{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-file-upload me-2"></i>
                    Upload Your Data
                </h4>
            </div>
            <div class="card-body">
                <!-- Upload Form -->
                <form method="POST" enctype="multipart/form-data" id="upload-form">
                    <div class="upload-area" id="upload-area">
                        <div class="upload-content">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <h5>Drag and drop your file here</h5>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" name="file" id="file-input" accept=".csv,.xlsx,.xls" required>
                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('file-input').click()">
                                <i class="fas fa-folder-open me-1"></i>
                                Browse Files
                            </button>
                        </div>
                    </div>
                    
                    <!-- File Info -->
                    <div id="file-info" class="file-info" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file me-2"></i>
                                <span id="file-name"></span>
                                <span class="text-muted ms-2" id="file-size"></span>
                            </div>
                            <button type="button" class="btn-close" id="remove-file"></button>
                        </div>
                        <div class="progress mt-2" id="upload-progress" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button type="submit" class="btn btn-primary btn-lg" id="upload-btn" disabled>
                            <i class="fas fa-upload me-2"></i>
                            Upload and Analyze
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Supported Formats -->
        <div class="mt-4">
            <h6>
                <i class="fas fa-info-circle me-2"></i>
                Supported Formats
            </h6>
            <div class="row g-2">
                <div class="col-md-4">
                    <div class="format-card">
                        <i class="fas fa-file-csv"></i>
                        <strong>CSV Files</strong>
                        <small>Comma-separated values with automatic encoding detection</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="format-card">
                        <i class="fas fa-file-excel"></i>
                        <strong>Excel Files</strong>
                        <small>.xlsx and .xls formats supported</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="format-card">
                        <i class="fas fa-database"></i>
                        <strong>Size Limit</strong>
                        <small>Maximum 16MB file size, up to 100K rows</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tips -->
        <div class="tips-section mt-4">
            <h6>
                <i class="fas fa-lightbulb me-2"></i>
                Tips for Better Results
            </h6>
            <ul class="list-unstyled">
                <li><i class="fas fa-check text-success me-2"></i>Ensure your data has clear column headers</li>
                <li><i class="fas fa-check text-success me-2"></i>Remove any merged cells in Excel files</li>
                <li><i class="fas fa-check text-success me-2"></i>Use consistent date formats throughout your data</li>
                <li><i class="fas fa-check text-success me-2"></i>Avoid special characters in column names</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// File upload handling
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
const fileInfo = document.getElementById('file-info');
const fileName = document.getElementById('file-name');
const fileSize = document.getElementById('file-size');
const uploadBtn = document.getElementById('upload-btn');
const removeFileBtn = document.getElementById('remove-file');
const uploadForm = document.getElementById('upload-form');

// Drag and drop events
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

// Remove file
removeFileBtn.addEventListener('click', () => {
    fileInput.value = '';
    fileInfo.style.display = 'none';
    uploadBtn.disabled = true;
    uploadArea.style.display = 'block';
});

// Handle file selection
function handleFileSelect(file) {
    // Validate file type
    const allowedTypes = ['.csv', '.xlsx', '.xls'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!allowedTypes.includes(fileExtension)) {
        showInlineNotification('Please select a CSV or Excel file', 'warning');
        return;
    }
    
    // Validate file size (16MB)
    const maxSize = 16 * 1024 * 1024;
    if (file.size > maxSize) {
        showInlineNotification('File size must be less than 16MB', 'warning');
        return;
    }
    
    // Update file info
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    
    // Show file info and hide upload area
    uploadArea.style.display = 'none';
    fileInfo.style.display = 'block';
    uploadBtn.disabled = false;
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Form submission with progress
uploadForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(uploadForm);
    const xhr = new XMLHttpRequest();
    
    // Show progress bar
    const progressBar = document.getElementById('upload-progress');
    progressBar.style.display = 'block';
    
    // Progress tracking
    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressBar.querySelector('.progress-bar').style.width = percentComplete + '%';
        }
    });
    
    // Success handler
    xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
            // Redirect to preview page
            window.location.href = '/preview';
        } else {
            showInlineNotification('Upload failed. Please try again.', 'danger');
            progressBar.style.display = 'none';
        }
    });
    
    // Error handler
    xhr.addEventListener('error', () => {
        showInlineNotification('Upload failed. Please try again.', 'danger');
        progressBar.style.display = 'none';
    });
    
    // Send request
    xhr.open('POST', '/upload');
    xhr.send(formData);
});
</script>
{% endblock %}
